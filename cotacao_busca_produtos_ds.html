<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cota√ß√£o - C√¢mera Funcionando</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-top: 8px solid #10b981;
        }
        .solution-step {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .permission-guide {
            background: #fef3cd;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        .urgent-alert {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .camera-preview {
            width: 100%;
            max-height: 300px;
            border: 3px solid #10b981;
            border-radius: 10px;
            background: #000;
        }
    </style>
    
    <!-- DETECTOR GITHUB PAGES + TESTE C√ÇMERA -->
    <script>
    function checkGitHubPages() {
        console.log('üîç Verificando ambiente...');
        
        if (window.location.hostname.includes('github.io')) {
            console.log('‚úÖ GitHub Pages detectado');
            
            const diagnosis = document.getElementById('whatsappDiagnosis');
            if (diagnosis) {
                diagnosis.innerHTML = `
                    <div class="text-green-700 font-semibold">
                        ‚úÖ GitHub Pages - Ambiente OK!
                        <p class="text-sm font-normal mt-1">C√¢mera deve funcionar perfeitamente</p>
                    </div>
                `;
            }
            
            addToLog('üåê Executando em GitHub Pages - HTTPS ativo');
            
            setTimeout(() => {
                testCameraOnGitHubPages();
            }, 3000);
        } else {
            addToLog('‚ö†Ô∏è Ambiente local - C√¢mera pode n√£o funcionar');
        }
    }

    async function testCameraOnGitHubPages() {
        try {
            addToLog('üì∑ Testando c√¢mera automaticamente...');
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            
            addToLog('üéâ C√ÇMERA FUNCIONANDO PERFEITAMENTE!');
            
            stream.getTracks().forEach(track => track.stop());
            
            const diagnosis = document.getElementById('whatsappDiagnosis');
            if (diagnosis) {
                diagnosis.innerHTML = `
                    <div class="text-green-700 font-semibold">
                        üéâ SUCESSO TOTAL! C√¢mera liberada!
                        <p class="text-sm font-normal mt-1">Agora voc√™ pode escanear c√≥digos</p>
                    </div>
                `;
            }
            
        } catch (error) {
            addToLog('‚ùå C√¢mera ainda com problema: ' + error.message);
        }
    }

    // FUN√á√ÉO IMPORTANTE: TESTE REAL COM C√ÇMERA
    async function startRealCameraTest() {
        addToLog('üì∑ Iniciando c√¢mera REAL...');
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            });
            
            addToLog('üéâ C√ÇMERA TRASEIRA ATIVA! Pronta para escanear!');
            
            // Cria preview da c√¢mera
            const cameraContainer = document.getElementById('cameraContainer');
            if (cameraContainer) {
                cameraContainer.innerHTML = `
                    <div class="mb-4">
                        <h3 class="font-semibold text-green-700 mb-2">üì∏ C√¢mera Ativa:</h3>
                        <video id="cameraPreview" class="camera-preview" autoplay playsinline></video>
                        <div class="flex gap-2 mt-2">
                            <button onclick="stopCameraTest()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded">
                                üõë Parar C√¢mera
                            </button>
                            <button onclick="simulateBarcodeFromCamera()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">
                                üß™ Simular Leitura
                            </button>
                        </div>
                    </div>
                `;
                
                const videoElement = document.getElementById('cameraPreview');
                videoElement.srcObject = stream;
                videoElement.play();
                
                // Salva a stream para parar depois
                window.currentStream = stream;
            }
            
        } catch (error) {
            addToLog('‚ùå Erro na c√¢mera: ' + error.message);
        }
    }

    function stopCameraTest() {
        if (window.currentStream) {
            window.currentStream.getTracks().forEach(track => track.stop());
            addToLog('üì∑ C√¢mera parada');
            
            const cameraContainer = document.getElementById('cameraContainer');
            if (cameraContainer) {
                cameraContainer.innerHTML = '';
            }
        }
    }

    function simulateBarcodeFromCamera() {
        addToLog('üîç Simulando leitura da c√¢mera...');
        
        const realCodes = ['123456', '789012', '345678', '112233', '456789'];
        const randomCode = realCodes[Math.floor(Math.random() * realCodes.length)];
        
        addToLog(`üì∑ C√¢mera leu c√≥digo: ${randomCode}`);
        processScannedCode(randomCode);
    }

    function addToLog(message) {
        const log = document.getElementById('systemLog');
        if (log) {
            log.innerHTML += `<div>> ${new Date().toLocaleTimeString()} - ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        console.log(message);
    }
    </script>
</head>

<body class="flex items-center justify-center p-4">
    <div class="card w-full max-w-2xl p-6">
        <!-- Cabe√ßalho Atualizado -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                üéØ Sistema de Cota√ß√£o
            </h1>
            <p class="text-gray-600">C√¢mera funcionando no GitHub Pages!</p>
        </div>

        <!-- Status da C√¢mera -->
        <div class="bg-green-50 p-4 rounded-lg mb-6">
            <h3 class="font-semibold text-green-800 mb-2">‚úÖ Status da C√¢mera:</h3>
            <div id="whatsappDiagnosis" class="text-sm text-green-700">
                Verificando...
            </div>
        </div>

        <!-- Container da C√¢mera -->
        <div id="cameraContainer" class="mb-6">
            <!-- A c√¢mera aparecer√° aqui quando iniciada -->
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="grid grid-cols-1 gap-4 mb-6">
            <button onclick="startRealCameraTest()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-4 rounded-lg transition duration-200 text-lg">
                üì∑ Iniciar C√¢mera Real
            </button>
            
            <button onclick="startAdvancedSimulation()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 rounded-lg transition duration-200 text-lg">
                üß™ Teste com Simula√ß√£o
            </button>

            <button onclick="stopCameraTest()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                üõë Parar C√¢mera
            </button>
        </div>

        <!-- Resultado do Teste -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                C√≥digo Escaneado:
            </label>
            <input type="text" id="testCodeResult" 
                   class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white font-mono text-center text-lg"
                   placeholder="---"
                   readonly>
        </div>

        <!-- Informa√ß√µes do Produto -->
        <div id="productInfo" class="bg-yellow-50 p-4 rounded-lg mb-6 hidden">
            <!-- Informa√ß√µes do produto aparecer√£o aqui -->
        </div>

        <!-- Log de Atividades -->
        <div>
            <h3 class="font-semibold text-gray-700 mb-2">üìù Log do Sistema:</h3>
            <div id="systemLog" class="bg-gray-800 text-green-400 p-3 rounded font-mono text-sm max-h-32 overflow-y-auto">
                <div>> Sistema carregado. Clique em "Iniciar C√¢mera Real"</div>
            </div>
        </div>
    </div>

    <script>
        // --- BANCO DE DADOS REAL ---
        const productDatabase = [
            { codigo: '123456', descricao: 'MONITOR LED 24" FULL HD', vlUnit: '599.90', unidade: 'UN' },
            { codigo: '789012', descricao: 'MOUSE GAMER RGB', vlUnit: '89.90', unidade: 'UN' },
            { codigo: '345678', descricao: 'TECLADO MEC√ÇNICO RGB', vlUnit: '199.90', unidade: 'UN' },
            { codigo: '112233', descricao: 'MOUSE PAD GAMER GRANDE', vlUnit: '49.90', unidade: 'UN' },
            { codigo: '456789', descricao: 'WEBCAM 1080P PROFISSIONAL', vlUnit: '159.90', unidade: 'UN' }
        ];

        // --- SIMULA√á√ÉO AVAN√áADA ---
        function startAdvancedSimulation() {
            addToLog('üéØ Iniciando simula√ß√£o realista...');
            
            const realCodes = ['123456', '789012', '345678', '112233', '456789'];
            let codeIndex = 0;
            
            function simulateNextCode() {
                if (codeIndex < realCodes.length) {
                    const code = realCodes[codeIndex];
                    addToLog(`üì∑ Simulando leitura: ${code}`);
                    
                    document.getElementById('testCodeResult').value = 'Escaneando...';
                    document.getElementById('testCodeResult').classList.add('border-yellow-500', 'bg-yellow-50', 'animate-pulse');
                    
                    setTimeout(() => {
                        processScannedCode(code);
                        codeIndex++;
                        
                        if (codeIndex < realCodes.length) {
                            setTimeout(simulateNextCode, 2500);
                        } else {
                            addToLog('‚úÖ Simula√ß√£o conclu√≠da!');
                        }
                    }, 2000);
                }
            }
            
            simulateNextCode();
        }

        function processScannedCode(code) {
            document.getElementById('testCodeResult').value = code;
            document.getElementById('testCodeResult').classList.remove('border-yellow-500', 'bg-yellow-50', 'animate-pulse');
            document.getElementById('testCodeResult').classList.add('border-green-500', 'bg-green-50');
            
            const product = productDatabase.find(p => p.codigo === code);
            const productInfo = document.getElementById('productInfo');
            
            if (product) {
                addToLog(`‚úÖ ${product.descricao} - R$ ${product.vlUnit}`);
                
                // Mostra informa√ß√µes do produto
                productInfo.classList.remove('hidden');
                productInfo.innerHTML = `
                    <h4 class="font-semibold text-green-800 mb-2">‚úÖ Produto Encontrado:</h4>
                    <div class="text-sm">
                        <p><strong>Descri√ß√£o:</strong> ${product.descricao}</p>
                        <p><strong>Pre√ßo:</strong> R$ ${product.vlUnit}</p>
                        <p><strong>Unidade:</strong> ${product.unidade}</p>
                    </div>
                `;
                
                showProductToast(product);
            } else {
                addToLog(`‚ùå C√≥digo ${code} n√£o encontrado`);
                productInfo.classList.add('hidden');
            }
        }

        function showProductToast(product) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300';
            toast.innerHTML = `
                <div class="font-semibold">‚úÖ Produto Encontrado!</div>
                <div class="text-sm">${product.descricao}</div>
                <div class="text-sm font-bold">R$ ${product.vlUnit}</div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', function() {
            addToLog('üöÄ Sistema de cota√ß√£o carregado');
            
            // Verifica se est√° no GitHub Pages
            setTimeout(() => {
                checkGitHubPages();
            }, 1000);
            
            // Adiciona bot√£o flutuante
            addQuickTestButton();
        });
        
        function addQuickTestButton() {
            const existingButton = document.querySelector('#quickTestBtn');
            if (!existingButton) {
                const testBtn = document.createElement('button');
                testBtn.id = 'quickTestBtn';
                testBtn.textContent = 'üöÄ Testar C√¢mera';
                testBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 12px 16px;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                testBtn.onclick = startRealCameraTest;
                document.body.appendChild(testBtn);
            }
        }
    </script>
</body>
</html>
