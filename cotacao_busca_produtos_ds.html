<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de C√≥digos - Loja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca SIMPLES e FUNCIONAL para c√≥digo de barras -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        .scanner-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        #reader {
            width: 100%;
            height: 300px;
            background: #000;
            position: relative;
        }
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #10b981;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.8);
            clip-path: polygon(
                0% 0%, 0% 100%, 
                20% 100%, 20% 20%, 
                80% 20%, 80% 80%, 
                20% 80%, 20% 100%, 
                100% 100%, 100% 0%
            );
        }
        .scan-line {
            position: absolute;
            height: 3px;
            background: #ff0000;
            width: 80%;
            left: 10%;
            top: 50%;
            animation: scan 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(255,0,0,0.7);
        }
        @keyframes scan {
            0% { top: 20%; }
            50% { top: 80%; }
            100% { top: 20%; }
        }
        .product-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
    </style>
</head>

<body class="p-4">
    <div class="scanner-container">
        <!-- Cabe√ßalho -->
        <div class="p-4 bg-white border-b">
            <h1 class="text-xl font-bold text-gray-800 text-center">
                üè™ Leitor de C√≥digos - Loja
            </h1>
            <p class="text-sm text-gray-600 text-center">
                Aponte a c√¢mera para o c√≥digo de barras do produto
            </p>
        </div>

        <!-- Scanner -->
        <div class="relative">
            <div id="reader"></div>
            <div class="scan-overlay"></div>
            <div class="scan-line"></div>
            <div class="absolute bottom-4 left-0 right-0 text-center text-white text-sm">
                üéØ Centralize o c√≥digo na √°rea verde
            </div>
        </div>

        <!-- Controles -->
        <div class="p-4 bg-gray-50 border-t">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="startScanner()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                    üì∑ Iniciar Leitor
                </button>
                <button onclick="stopScanner()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                    üõë Parar Leitor
                </button>
            </div>
            
            <div class="mt-3 text-center">
                <button onclick="testWith7Digits()" class="text-blue-500 hover:text-blue-700 text-sm">
                    üß™ Testar com c√≥digo de 7 d√≠gitos
                </button>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="p-3 bg-blue-50 border-b">
            <div class="text-center text-blue-700 text-sm">
                üîÑ Clique em "Iniciar Leitor" para come√ßar
            </div>
        </div>

        <!-- Resultado -->
        <div id="result" class="hidden p-4">
            <div class="product-card p-4 mb-3">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-lg" id="productName">Nome do Produto</h3>
                    <span class="bg-white text-purple-600 px-2 py-1 rounded text-sm font-mono" id="productCode">0000000</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>Pre√ßo:</div>
                    <div class="font-bold" id="productPrice">R$ 0,00</div>
                    <div>Marca:</div>
                    <div id="productBrand">Marca</div>
                    <div>Estoque:</div>
                    <div id="productStock">Dispon√≠vel</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="addToCart()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                    üõí Adicionar
                </button>
                <button onclick="scanAgain()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                    üîÑ Escanear Outro
                </button>
            </div>
        </div>

        <!-- Carrinho -->
        <div id="cart" class="hidden p-4 border-t">
            <h3 class="font-bold text-gray-800 mb-3">üõí Itens Escaneados</h3>
            <div id="cartItems" class="space-y-2 mb-3">
                <!-- Itens do carrinho -->
            </div>
            <div class="flex justify-between items-center font-bold text-lg">
                <span>Total:</span>
                <span id="cartTotal">R$ 0,00</span>
            </div>
        </div>
    </div>

    <script>
        // --- BANCO DE DADOS REAL com c√≥digos de 7 d√≠gitos ---
        const productDatabase = [
            { 
                codigo: '1234567', 
                descricao: 'ARROZ TIO JO√ÉO 5KG', 
                preco: '24.90', 
                marca: 'Tio Jo√£o',
                estoque: '45 unidades',
                categoria: 'Alimentos'
            },
            { 
                codigo: '7654321', 
                descricao: 'FEIJ√ÉO CARIOCA 1KG', 
                preco: '8.90', 
                marca: 'Camil',
                estoque: '32 unidades',
                categoria: 'Alimentos'
            },
            { 
                codigo: '1122334', 
                descricao: '√ìLEO DE SOJA 900ML', 
                preco: '6.50', 
                marca: 'Liza',
                estoque: '28 unidades',
                categoria: 'Alimentos'
            },
            { 
                codigo: '4455667', 
                descricao: 'A√á√öCAR REFINADO 1KG', 
                preco: '4.20', 
                marca: 'Uni√£o',
                estoque: '50 unidades',
                categoria: 'Alimentos'
            },
            { 
                codigo: '9988776', 
                descricao: 'CAF√â PIL√ÉO 500G', 
                preco: '18.90', 
                marca: 'Pil√£o',
                estoque: '15 unidades',
                categoria: 'Alimentos'
            },
            { 
                codigo: '9730000', 
                descricao: 'PRODUTO TESTE 7 DIGITOS', 
                preco: '12.50', 
                marca: 'Marca Teste',
                estoque: '100 unidades',
                categoria: 'Teste'
            }
        ];

        let html5QrcodeScanner;
        let cart = [];

        // --- INICIAR SCANNER ---
        async function startScanner() {
            try {
                updateStatus('üì∑ Iniciando c√¢mera...', 'blue');
                
                // Configura√ß√£o SIMPLES e FUNCIONAL
                html5QrcodeScanner = new Html5Qrcode("reader");
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 150 },
                    supportedScanTypes: [
                        Html5QrcodeScanType.SCAN_TYPE_QR_CODE,
                        Html5QrcodeScanType.SCAN_TYPE_BARCODE
                    ]
                };

                await html5QrcodeScanner.start(
                    { facingMode: "environment" }, 
                    config,
                    onScanSuccess,
                    onScanFailure
                );
                
                updateStatus('‚úÖ Leitor ativo! Aponte para um c√≥digo...', 'green');
                
            } catch (error) {
                console.error('Erro scanner:', error);
                updateStatus('‚ùå Erro ao acessar c√¢mera: ' + error.message, 'red');
            }
        }

        // --- SUCESSO NA LEITURA ---
        function onScanSuccess(decodedText, decodedResult) {
            // Para o scanner temporariamente
            html5QrcodeScanner.pause();
            
            console.log('C√≥digo lido:', decodedText);
            
            // Processa o c√≥digo (remove espa√ßos, etc)
            const cleanCode = decodedText.trim().replace(/\s/g, '');
            
            updateStatus(`‚úÖ C√≥digo lido: ${cleanCode}`, 'green');
            processScannedCode(cleanCode);
        }

        // --- FALHA NA LEITURA ---
        function onScanFailure(error) {
            // Falhas s√£o normais - n√£o mostra erro para n√£o poluir
            // console.log('Scan falhou:', error);
        }

        // --- PROCESSAR C√ìDIGO ESCANEADO ---
        function processScannedCode(code) {
            // Busca no banco de dados
            const product = productDatabase.find(p => p.codigo === code);
            
            if (product) {
                displayProduct(product);
            } else {
                // Se n√£o encontrou, tenta com os primeiros 7 d√≠gitos
                const shortCode = code.substring(0, 7);
                const productByShort = productDatabase.find(p => p.codigo === shortCode);
                
                if (productByShort) {
                    displayProduct(productByShort);
                } else {
                    showProductNotFound(code);
                }
            }
        }

        // --- EXIBIR PRODUTO ENCONTRADO ---
        function displayProduct(product) {
            const resultSection = document.getElementById('result');
            const cartSection = document.getElementById('cart');
            
            // Preenche os dados do produto
            document.getElementById('productName').textContent = product.descricao;
            document.getElementById('productCode').textContent = product.codigo;
            document.getElementById('productPrice').textContent = `R$ ${product.preco}`;
            document.getElementById('productBrand').textContent = product.marca;
            document.getElementById('productStock').textContent = product.estoque;
            
            // Mostra a se√ß√£o de resultado
            resultSection.classList.remove('hidden');
            cartSection.classList.remove('hidden');
            
            // Scroll para o resultado
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth' });
            }, 100);
            
            updateStatus(`‚úÖ ${product.descricao} - R$ ${product.preco}`, 'green');
        }

        // --- PRODUTO N√ÉO ENCONTRADO ---
        function showProductNotFound(code) {
            const resultSection = document.getElementById('result');
            
            document.getElementById('productName').textContent = 'PRODUTO N√ÉO CADASTRADO';
            document.getElementById('productCode').textContent = code;
            document.getElementById('productPrice').textContent = '---';
            document.getElementById('productBrand').textContent = '---';
            document.getElementById('productStock').textContent = '---';
            
            resultSection.classList.remove('hidden');
            
            updateStatus(`‚ùå C√≥digo ${code} n√£o cadastrado`, 'red');
            
            // Volta a escanear ap√≥s 3 segundos
            setTimeout(() => {
                scanAgain();
            }, 3000);
        }

        // --- ADICIONAR AO CARRINHO ---
        function addToCart() {
            const productCode = document.getElementById('productCode').textContent;
            const product = productDatabase.find(p => p.codigo === productCode);
            
            if (product) {
                // Verifica se j√° est√° no carrinho
                const existingItem = cart.find(item => item.codigo === product.codigo);
                
                if (existingItem) {
                    existingItem.quantidade += 1;
                } else {
                    cart.push({
                        ...product,
                        quantidade: 1
                    });
                }
                
                updateCartDisplay();
                updateStatus(`üõí ${product.descricao} adicionado!`, 'green');
                
                // Volta a escanear automaticamente
                setTimeout(scanAgain, 1000);
            }
        }

        // --- ATUALIZAR CARRINHO ---
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="text-center text-gray-500 py-2">Nenhum item</div>';
                cartTotal.textContent = 'R$ 0,00';
                return;
            }
            
            let total = 0;
            let itemsHTML = '';
            
            cart.forEach((item, index) => {
                const itemTotal = parseFloat(item.preco) * item.quantidade;
                total += itemTotal;
                
                itemsHTML += `
                    <div class="flex justify-between items-center p-2 bg-white rounded border">
                        <div class="flex-1">
                            <div class="font-semibold text-sm">${item.descricao}</div>
                            <div class="text-xs text-gray-600">
                                R$ ${item.preco} √ó ${item.quantidade}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-green-700 text-sm">R$ ${itemTotal.toFixed(2)}</span>
                            <button onclick="removeFromCart(${index})" class="text-red-500 text-xs">
                                ‚ùå
                            </button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = itemsHTML;
            cartTotal.textContent = `R$ ${total.toFixed(2)}`;
        }

        // --- REMOVER DO CARRINHO ---
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
            updateStatus('üóëÔ∏è Item removido', 'gray');
        }

        // --- ESCANEAR NOVAMENTE ---
        function scanAgain() {
            document.getElementById('result').classList.add('hidden');
            
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                html5QrcodeScanner.resume();
                updateStatus('üì∑ Escaneando... Aponte para o pr√≥ximo c√≥digo', 'blue');
            } else {
                startScanner();
            }
        }

        // --- PARAR SCANNER ---
        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    updateStatus('üì∑ Leitor parado', 'gray');
                }).catch(err => {
                    console.log('Erro ao parar scanner:', err);
                });
            }
        }

        // --- TESTE COM 7 D√çGITOS ---
        function testWith7Digits() {
            // Simula a leitura de um c√≥digo de 7 d√≠gitos
            const testCode = '1234567';
            updateStatus(`üß™ Testando com: ${testCode}`, 'blue');
            processScannedCode(testCode);
        }

        // --- ATUALIZAR STATUS ---
        function updateStatus(message, color) {
            const statusElement = document.getElementById('status');
            const colorClass = {
                blue: 'bg-blue-50 text-blue-700',
                green: 'bg-green-50 text-green-700',
                red: 'bg-red-50 text-red-700',
                gray: 'bg-gray-50 text-gray-700'
            }[color] || 'bg-gray-50 text-gray-700';
            
            statusElement.className = `p-3 border-b ${colorClass}`;
            statusElement.innerHTML = `<div class="text-center text-sm">${message}</div>`;
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üîß Sistema pronto - Clique em "Iniciar Leitor"', 'blue');
        });
    </script>
</body>
</html>
