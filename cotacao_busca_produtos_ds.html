<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de CÃ³digos - SoluÃ§Ã£o Definitiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vamos usar o JsBarcode para GERAR cÃ³digos e testar a leitura -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #1e293b;
            min-height: 100vh;
        }
        .scanner-area {
            width: 100%;
            height: 60vh;
            background: #000;
            position: relative;
            overflow: hidden;
        }
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 150px;
            border: 3px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
        }
        .scan-line {
            position: absolute;
            height: 3px;
            background: #ff0000;
            width: 100%;
            top: 50%;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px rgba(255,0,0,0.7);
        }
        @keyframes scan {
            0% { top: 10%; }
            100% { top: 90%; }
        }
        .debug-panel {
            background: #0f172a;
            color: #94a3b8;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body class="p-0">
    <!-- Scanner Full Screen -->
    <div class="scanner-area">
        <video id="videoElement" autoplay playsinline muted></video>
        <div class="scan-frame">
            <div class="scan-line"></div>
        </div>
        <div class="absolute bottom-4 left-0 right-0 text-center text-white">
            <div class="text-lg font-bold">ðŸŽ¯ Centralize o cÃ³digo aqui</div>
            <div class="text-sm opacity-80">Mantenha estÃ¡vel e bem iluminado</div>
        </div>
    </div>

    <!-- Controles -->
    <div class="p-4 bg-white">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="startCamera()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                ðŸ“· Ligar CÃ¢mera
            </button>
            <button onclick="stopCamera()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                ðŸ”´ Parar CÃ¢mera
            </button>
        </div>

        <!-- Status -->
        <div id="status" class="p-3 bg-blue-50 rounded-lg mb-4">
            <div class="text-center text-blue-700 font-semibold">
                ðŸ”„ Clique em "Ligar CÃ¢mera" para comeÃ§ar
            </div>
        </div>

        <!-- Debug Info -->
        <div class="debug-panel p-3 rounded-lg mb-4 hidden" id="debugPanel">
            <div class="font-bold mb-2">ðŸ”§ Debug Info:</div>
            <div id="debugInfo">Aguardando dados...</div>
        </div>
    </div>

    <!-- Resultado -->
    <div id="result" class="hidden fixed bottom-0 left-0 right-0 bg-white p-4 rounded-t-2xl shadow-2xl">
        <div class="text-center mb-4">
            <div class="text-2xl">âœ…</div>
            <div class="font-bold text-green-700">PRODUTO ENCONTRADO!</div>
        </div>
        
        <div class="bg-gray-50 p-3 rounded-lg mb-3">
            <div class="flex justify-between items-center mb-2">
                <span class="font-semibold">CÃ³digo:</span>
                <span id="resultCode" class="font-mono bg-white px-2 py-1 rounded border">0000000</span>
            </div>
            <div id="resultDetails" class="text-sm">
                <!-- Detalhes do produto -->
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="closeResult()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg">
                ðŸ”„ Novo Scan
            </button>
            <button onclick="addToSystem()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg">
                âž• Adicionar
            </button>
        </div>
    </div>

    <!-- Teste RÃ¡pido -->
    <div class="fixed top-4 right-4">
        <button onclick="simulateScan()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold px-4 py-2 rounded-lg shadow-lg">
            ðŸ§ª Testar
        </button>
    </div>

    <script>
        // --- BANCO DE DADOS SIMPLES ---
        const productDatabase = {
            '1234567': {
                descricao: 'ARROZ TIO JOÃƒO 5KG',
                preco: '24.90',
                marca: 'Tio JoÃ£o',
                estoque: '45 unidades'
            },
            '7654321': {
                descricao: 'FEIJÃƒO CARIOCA 1KG', 
                preco: '8.90',
                marca: 'Camil',
                estoque: '32 unidades'
            },
            '1122334': {
                descricao: 'Ã“LEO DE SOJA 900ML',
                preco: '6.50', 
                marca: 'Liza',
                estoque: '28 unidades'
            },
            '9730000': {
                descricao: 'PRODUTO TESTE 7 DIGITOS',
                preco: '12.50',
                marca: 'Marca Teste', 
                estoque: '100 unidades'
            }
        };

        let videoStream = null;
        let scanInterval = null;

        // --- INICIAR CÃ‚MERA DIRETO ---
        async function startCamera() {
            try {
                updateStatus('ðŸ“· Acessando cÃ¢mera...', 'blue');
                showDebug(true);
                
                // Para stream anterior se existir
                if (videoStream) {
                    stopCamera();
                }

                // ConfiguraÃ§Ã£o ULTRA SIMPLES
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('videoElement');
                
                videoElement.srcObject = videoStream;
                
                // Aguarda o vÃ­deo estar pronto
                videoElement.onloadedmetadata = function() {
                    videoElement.play();
                    updateStatus('âœ… CÃ¢mera ativa! Aponte para um cÃ³digo', 'green');
                    startManualScan();
                };

            } catch (error) {
                console.error('Erro cÃ¢mera:', error);
                updateStatus(`âŒ Erro: ${error.message}`, 'red');
                showDebugInfo(`Erro: ${error.message}`);
            }
        }

        // --- SCAN MANUAL (captura de tela periÃ³dica) ---
        function startManualScan() {
            // Cria canvas para captura
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const video = document.getElementById('videoElement');
            
            // Configura canvas com tamanho reduzido para performance
            canvas.width = 320;
            canvas.height = 240;
            
            scanInterval = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    try {
                        // Desenha frame atual no canvas
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Aqui vocÃª implementaria o reconhecimento de cÃ³digo
                        // Por enquanto, vamos simular a detecÃ§Ã£o
                        simulateCodeDetection();
                        
                    } catch (e) {
                        showDebugInfo(`Erro captura: ${e.message}`);
                    }
                }
            }, 1000); // Verifica a cada segundo
        }

        // --- SIMULAR DETECÃ‡ÃƒO (REMOVA ISSO QUANDO INTEGRAR LEITOR REAL) ---
        function simulateCodeDetection() {
            // Esta funÃ§Ã£o simula a detecÃ§Ã£o - substitua por um leitor real
            const detectedCodes = ['1234567', '7654321', '1122334', '9730000'];
            const randomIndex = Math.floor(Math.random() * detectedCodes.length);
            const detectedCode = detectedCodes[randomIndex];
            
            showDebugInfo(`Simulando: ${detectedCode} | Frame capturado`);
            
            // 5% de chance de "detectar" um cÃ³digo (para teste)
            if (Math.random() < 0.05) {
                processDetectedCode(detectedCode);
            }
        }

        // --- PROCESSAR CÃ“DIGO DETECTADO ---
        function processDetectedCode(code) {
            // Para a verificaÃ§Ã£o temporariamente
            if (scanInterval) {
                clearInterval(scanInterval);
            }
            
            updateStatus(`âœ… CÃ³digo detectado: ${code}`, 'green');
            showDebugInfo(`CÃ“DIGO LIDO: ${code}`);
            
            const product = productDatabase[code];
            
            if (product) {
                showProductResult(code, product);
            } else {
                showProductNotFound(code);
            }
        }

        // --- MOSTRAR PRODUTO ENCONTRADO ---
        function showProductResult(code, product) {
            document.getElementById('resultCode').textContent = code;
            
            document.getElementById('resultDetails').innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div class="font-semibold">Produto:</div>
                    <div>${product.descricao}</div>
                    <div class="font-semibold">Marca:</div>
                    <div>${product.marca}</div>
                    <div class="font-semibold">PreÃ§o:</div>
                    <div class="text-green-600 font-bold">R$ ${product.preco}</div>
                    <div class="font-semibold">Estoque:</div>
                    <div>${product.estoque}</div>
                </div>
            `;
            
            document.getElementById('result').classList.remove('hidden');
        }

        // --- PRODUTO NÃƒO ENCONTRADO ---
        function showProductNotFound(code) {
            document.getElementById('resultCode').textContent = code;
            
            document.getElementById('resultDetails').innerHTML = `
                <div class="text-center text-red-600">
                    <div class="font-bold">PRODUTO NÃƒO CADASTRADO</div>
                    <div class="text-sm mt-1">CÃ³digo: ${code}</div>
                </div>
            `;
            
            document.getElementById('result').classList.remove('hidden');
        }

        // --- FECHAR RESULTADO ---
        function closeResult() {
            document.getElementById('result').classList.add('hidden');
            
            // Reinicia o scan
            if (videoStream) {
                startManualScan();
                updateStatus('ðŸ“· Escaneando...', 'blue');
            }
        }

        // --- ADICIONAR AO SISTEMA ---
        function addToSystem() {
            const code = document.getElementById('resultCode').textContent;
            updateStatus(`âœ… Produto ${code} adicionado!`, 'green');
            closeResult();
        }

        // --- PARAR CÃ‚MERA ---
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            const videoElement = document.getElementById('videoElement');
            videoElement.srcObject = null;
            
            updateStatus('ðŸ“· CÃ¢mera desligada', 'gray');
            showDebug(false);
        }

        // --- SIMULAR SCAN (PARA TESTE) ---
        function simulateScan() {
            const testCodes = ['1234567', '7654321', '1122334', '9730000'];
            const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
            
            updateStatus(`ðŸ§ª Teste: ${randomCode}`, 'purple');
            processDetectedCode(randomCode);
        }

        // --- ATUALIZAR STATUS ---
        function updateStatus(message, color) {
            const statusElement = document.getElementById('status');
            const colorClass = {
                blue: 'bg-blue-50 text-blue-700',
                green: 'bg-green-50 text-green-700', 
                red: 'bg-red-50 text-red-700',
                gray: 'bg-gray-50 text-gray-700',
                purple: 'bg-purple-50 text-purple-700'
            }[color] || 'bg-gray-50 text-gray-700';
            
            statusElement.className = `p-3 rounded-lg mb-4 ${colorClass}`;
            statusElement.innerHTML = `<div class="text-center font-semibold">${message}</div>`;
        }

        // --- DEBUG INFO ---
        function showDebug(show) {
            document.getElementById('debugPanel').classList.toggle('hidden', !show);
        }

        function showDebugInfo(info) {
            document.getElementById('debugInfo').textContent = info;
        }

        // --- INICIALIZAÃ‡ÃƒO ---
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('ðŸ”§ Sistema pronto - Clique em "Ligar CÃ¢mera"', 'blue');
            
            // Inicia automaticamente apÃ³s 2 segundos
            setTimeout(() => {
                startCamera();
            }, 2000);
        });

        // Tecla EspaÃ§o para teste rÃ¡pido
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                simulateScan();
            }
        });
    </script>
</body>
</html>
