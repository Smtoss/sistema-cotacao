<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cota√ß√£o - Leitor de C√≥digos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca QuaggaJS para ler c√≥digos de barras -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-top: 8px solid #10b981;
        }
        .camera-preview {
            width: 100%;
            max-height: 300px;
            border: 3px solid #10b981;
            border-radius: 10px;
            background: #000;
        }
        .scanner-overlay {
            position: relative;
        }
        .scanner-line {
            position: absolute;
            height: 2px;
            background: #ff0000;
            width: 100%;
            animation: scan 2s infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        #interactive.viewport {
            position: relative;
        }
    </style>
</head>

<body class="flex items-center justify-center p-4">
    <div class="card w-full max-w-2xl p-6">
        <!-- Cabe√ßalho -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                üéØ Leitor de C√≥digos de Barras
            </h1>
            <p class="text-gray-600">Aponte para o c√≥digo na embalagem</p>
        </div>

        <!-- Status -->
        <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <h3 class="font-semibold text-blue-800 mb-2">üìä Status do Leitor:</h3>
            <div id="scannerStatus" class="text-sm text-blue-700">
                Pronto para iniciar...
            </div>
        </div>

        <!-- Container do Scanner -->
        <div id="scannerContainer" class="mb-4">
            <div class="text-center text-gray-500 mb-4">
                üëÜ Clique em "Iniciar Leitor" para escanear c√≥digos
            </div>
        </div>

        <!-- Bot√µes de Controle -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="startBarcodeScanner()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                üì∑ Iniciar Leitor
            </button>
            <button onclick="stopBarcodeScanner()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition duration-200">
                üõë Parar Leitor
            </button>
            <button onclick="startSimulation()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition duration-200 col-span-2">
                üß™ Modo Simula√ß√£o
            </button>
        </div>

        <!-- Resultado -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                C√≥digo Lido:
            </label>
            <input type="text" id="barcodeResult" 
                   class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white font-mono text-center text-lg font-bold"
                   placeholder="---"
                   readonly>
        </div>

        <!-- Informa√ß√µes do Produto -->
        <div id="productInfo" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 hidden">
            <h4 class="font-semibold text-green-800 mb-2">‚úÖ Produto Encontrado:</h4>
            <div id="productDetails" class="text-sm">
                <!-- Detalhes do produto aparecer√£o aqui -->
            </div>
        </div>

        <!-- Dicas -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
            <h4 class="font-semibold text-yellow-800 mb-1">üí° Dicas para escanear:</h4>
            <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                <li>Mantenha o c√≥digo a ~15cm da c√¢mera</li>
                <li>Boa ilumina√ß√£o √© essencial</li>
                <li>Mantenha a c√¢mera est√°vel</li>
                <li>Foque na √°rea do c√≥digo de barras</li>
            </ul>
        </div>

        <!-- Log -->
        <div>
            <h3 class="font-semibold text-gray-700 mb-2">üìù Log:</h3>
            <div id="scannerLog" class="bg-gray-800 text-green-400 p-3 rounded font-mono text-sm max-h-32 overflow-y-auto">
                <div>> Sistema carregado. Clique em "Iniciar Leitor"</div>
            </div>
        </div>
    </div>

    <script>
        // --- BANCO DE DADOS DE PRODUTOS ---
        const productDatabase = [
            { 
                codigo: '7891000315507', 
                descricao: 'NESTON 200G', 
                vlUnit: '8.90', 
                unidade: 'UN',
                marca: 'Nestl√©'
            },
            { 
                codigo: '7891910000197', 
                descricao: 'A√á√öCAR CRISTAL 1KG', 
                vlUnit: '4.50', 
                unidade: 'UN',
                marca: 'Uni√£o'
            },
            { 
                codigo: '7891999010026', 
                descricao: 'ARROZ TIO JO√ÉO 1KG', 
                vlUnit: '6.90', 
                unidade: 'UN',
                marca: 'Tio Jo√£o'
            },
            { 
                codigo: '7893000366644', 
                descricao: 'CAF√â PIL√ÉO 500G', 
                vlUnit: '18.90', 
                unidade: 'UN',
                marca: 'Pil√£o'
            },
            { 
                codigo: '7894900011516', 
                descricao: 'COCA-COLA 2L', 
                vlUnit: '9.90', 
                unidade: 'UN',
                marca: 'Coca-Cola'
            },
            { 
                codigo: '7896051111011', 
                descricao: 'SAB√ÉO EM P√ì OMO 1KG', 
                vlUnit: '15.90', 
                unidade: 'UN',
                marca: 'Omo'
            }
        ];

        let isScannerActive = false;

        // --- FUN√á√ÉO PRINCIPAL: INICIAR LEITOR ---
        function startBarcodeScanner() {
            if (isScannerActive) {
                addToLog('‚ö†Ô∏è Scanner j√° est√° ativo');
                return;
            }

            addToLog('üì∑ Iniciando leitor de c√≥digos...');
            updateScannerStatus('Iniciando...', 'blue');

            // Configura√ß√£o do QuaggaJS
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scannerContainer'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // C√¢mera traseira
                    }
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader",
                        "code_128_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    addToLog('‚ùå Erro ao iniciar scanner: ' + err.message);
                    updateScannerStatus('Erro ao iniciar', 'red');
                    return;
                }
                
                addToLog('‚úÖ Scanner iniciado! Aponte para um c√≥digo...');
                updateScannerStatus('üì∑ Escaneando... Aponte para o c√≥digo', 'green');
                
                Quagga.start();
                isScannerActive = true;
                
                // Cria visualiza√ß√£o do scanner
                createScannerView();
            });

            // Detecta quando um c√≥digo √© lido
            Quagga.onDetected(function(result) {
                if (result && result.codeResult) {
                    const code = result.codeResult.code;
                    addToLog(`üì∑ C√≥digo detectado: ${code}`);
                    processBarcode(code);
                }
            });
        }

        // --- PARAR SCANNER ---
        function stopBarcodeScanner() {
            if (isScannerActive) {
                Quagga.stop();
                isScannerActive = false;
                addToLog('üõë Scanner parado');
                updateScannerStatus('Scanner parado', 'gray');
                
                // Limpa a visualiza√ß√£o
                const scannerContainer = document.getElementById('scannerContainer');
                scannerContainer.innerHTML = '<div class="text-center text-gray-500">üëÜ Clique em "Iniciar Leitor" para escanear c√≥digos</div>';
            }
        }

        // --- CRIAR VISUALIZA√á√ÉO DO SCANNER ---
        function createScannerView() {
            const scannerContainer = document.getElementById('scannerContainer');
            scannerContainer.innerHTML = `
                <div class="scanner-overlay">
                    <div id="interactive" class="viewport"></div>
                    <div class="scanner-line"></div>
                </div>
                <div class="text-center text-sm text-green-600 mt-2">
                    üéØ Aponte a c√¢mera para o c√≥digo de barras
                </div>
            `;
        }

        // --- PROCESSAR C√ìDIGO LIDO ---
        function processBarcode(code) {
            // Atualiza o campo de resultado
            const resultField = document.getElementById('barcodeResult');
            resultField.value = code;
            resultField.classList.add('border-green-500', 'bg-green-50');
            
            // Busca o produto no banco de dados
            const product = productDatabase.find(p => p.codigo === code);
            const productInfo = document.getElementById('productInfo');
            const productDetails = document.getElementById('productDetails');
            
            if (product) {
                addToLog(`‚úÖ ${product.descricao} - R$ ${product.vlUnit}`);
                
                // Mostra informa√ß√µes detalhadas do produto
                productInfo.classList.remove('hidden');
                productDetails.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div><strong>Descri√ß√£o:</strong></div>
                        <div>${product.descricao}</div>
                        
                        <div><strong>Marca:</strong></div>
                        <div>${product.marca}</div>
                        
                        <div><strong>Pre√ßo:</strong></div>
                        <div class="font-bold text-green-700">R$ ${product.vlUnit}</div>
                        
                        <div><strong>Unidade:</strong></div>
                        <div>${product.unidade}</div>
                    </div>
                `;
                
                showSuccessToast(product);
                
                // Para o scanner automaticamente ap√≥s ler
                setTimeout(() => {
                    stopBarcodeScanner();
                }, 3000);
                
            } else {
                addToLog(`‚ùå C√≥digo ${code} n√£o encontrado no banco de dados`);
                productInfo.classList.add('hidden');
                
                productInfo.classList.remove('hidden');
                productInfo.classList.add('bg-red-50', 'border-red-200');
                productDetails.innerHTML = `
                    <div class="text-red-700">
                        <strong>Produto n√£o cadastrado</strong>
                        <p class="text-sm mt-1">C√≥digo: ${code}</p>
                        <p class="text-sm">Adicione este produto ao banco de dados</p>
                    </div>
                `;
            }
        }

        // --- MODO SIMULA√á√ÉO ---
        function startSimulation() {
            addToLog('üß™ Iniciando modo simula√ß√£o...');
            
            const testCodes = [
                '7891000315507', // NESTON
                '7894900011516', // COCA-COLA
                '7896051111011', // OMO
                '9999999999999'  // C√≥digo inv√°lido
            ];
            
            let index = 0;
            
            function simulateNext() {
                if (index < testCodes.length) {
                    const code = testCodes[index];
                    addToLog(`üß™ Simulando c√≥digo: ${code}`);
                    
                    const resultField = document.getElementById('barcodeResult');
                    resultField.value = 'Lendo...';
                    resultField.classList.add('border-yellow-500', 'bg-yellow-50', 'animate-pulse');
                    
                    setTimeout(() => {
                        processBarcode(code);
                        index++;
                        setTimeout(simulateNext, 3000);
                    }, 2000);
                } else {
                    addToLog('‚úÖ Simula√ß√£o conclu√≠da');
                }
            }
            
            simulateNext();
        }

        // --- FUN√á√ïES AUXILIARES ---
        function updateScannerStatus(message, color) {
            const status = document.getElementById('scannerStatus');
            const colorClass = {
                blue: 'text-blue-700',
                green: 'text-green-700',
                red: 'text-red-700',
                gray: 'text-gray-700'
            }[color] || 'text-gray-700';
            
            status.innerHTML = `<span class="${colorClass} font-semibold">${message}</span>`;
        }

        function addToLog(message) {
            const log = document.getElementById('scannerLog');
            log.innerHTML += `<div>> ${new Date().toLocaleTimeString()} - ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function showSuccessToast(product) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50';
            toast.innerHTML = `
                <div class="font-semibold">‚úÖ Produto Encontrado!</div>
                <div class="text-sm">${product.descricao}</div>
                <div class="text-sm font-bold">R$ ${product.vlUnit}</div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', function() {
            addToLog('üöÄ Leitor de c√≥digos carregado');
            updateScannerStatus('Pronto para iniciar', 'blue');
        });
    </script>
</body>
</html>
