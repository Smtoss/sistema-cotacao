<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor Code 128 - Alta Densidade</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .camera-section {
            position: relative;
            margin: 20px 0;
        }

        #camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        #camera {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 150px;
            border: 3px solid #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            z-index: 10;
        }

        .zoom-controls {
            text-align: center;
            margin: 15px 0;
        }

        .zoom-btn {
            padding: 10px 20px;
            margin: 0 5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .zoom-btn:hover {
            background: #1976D2;
        }

        .zoom-display {
            display: inline-block;
            margin: 0 15px;
            font-weight: bold;
            color: #333;
        }

        .config-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .config-item {
            margin: 10px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .results {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .debug {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            font-size: 12px;
            color: #856404;
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.ready {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Leitor Code 128 - C√≥digos de Alta Densidade</h1>
        
        <div class="config-panel">
            <h3>‚öôÔ∏è Configura√ß√µes do Leitor</h3>
            
            <div class="config-item">
                <label for="resolution">Resolu√ß√£o de Processamento:</label>
                <select id="resolution">
                    <option value="high">Alta (Recomendado para c√≥digos densos)</option>
                    <option value="medium">M√©dia</option>
                    <option value="low">Baixa</option>
                </select>
            </div>

            <div class="config-item">
                <label for="patchSize">Tamanho de An√°lise:</label>
                <select id="patchSize">
                    <option value="x-large">X-Large (Melhor para c√≥digos finos)</option>
                    <option value="large">Large</option>
                    <option value="medium">Medium</option>
                    <option value="small">Small</option>
                </select>
            </div>

            <div class="config-item">
                <label for="frequency">Frequ√™ncia de Verifica√ß√£o:</label>
                <select id="frequency">
                    <option value="5">Muito Alta (5ms)</option>
                    <option value="10">Alta (10ms)</option>
                    <option value="20" selected>Normal (20ms)</option>
                    <option value="50">Baixa (50ms)</option>
                </select>
            </div>
        </div>

        <div class="camera-section">
            <div id="camera-container">
                <video id="camera" autoplay playsinline></video>
                <div id="scan-area"></div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" onclick="adjustZoom(-0.3)">üîç -</button>
                <span class="zoom-display">Zoom: <span id="zoomLevel">1.0x</span></span>
                <button class="zoom-btn" onclick="adjustZoom(0.3)">üîç +</button>
            </div>

            <div class="status ready" id="status">Pronto para iniciar</div>

            <div style="text-align: center; margin: 15px 0;">
                <button class="zoom-btn" onclick="initCamera()" style="background: #4CAF50;">üé• Iniciar C√¢mera</button>
                <button class="zoom-btn" onclick="stopCamera()" style="background: #f44336;">‚èπ Parar</button>
            </div>
        </div>

        <div class="results">
            <h3>üìä Resultado da Leitura:</h3>
            <div id="result">Aguardando leitura...</div>
            <div class="debug" id="debugInfo"></div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
            <h4>üí° Dicas para C√≥digos de Alta Densidade:</h4>
            <ul>
                <li>Use <strong>Zoom 1.5x a 2.0x</strong> para c√≥digos com barras muito finas</li>
                <li>Mantenha boa ilumina√ß√£o no c√≥digo</li>
                <li>Posicione o c√≥digo paralelo √† c√¢mera</li>
                <li>Configure "Resolu√ß√£o Alta" e "Tamanho X-Large" no painel acima</li>
            </ul>
        </div>
    </div>

    <script>
        let stream = null;
        let currentZoom = 1.0;
        let isInitialized = false;

        const camera = document.getElementById('camera');
        const status = document.getElementById('status');
        const result = document.getElementById('result');
        const debugInfo = document.getElementById('debugInfo');
        const zoomLevel = document.getElementById('zoomLevel');

        // Configura√ß√µes adapt√°veis para c√≥digos densos
        function getQuaggaConfig() {
            const resolution = document.getElementById('resolution').value;
            const patchSize = document.getElementById('patchSize').value;
            const frequency = parseInt(document.getElementById('frequency').value);

            let config = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: camera,
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        aspectRatio: { ideal: 1.7777777778 }, // 16:9
                        frameRate: { ideal: 30 }
                    },
                    area: { // Define a √°rea de scan (90% central)
                        top: "5%",
                        right: "5%",
                        left: "5%",
                        bottom: "5%"
                    }
                },
                decoder: {
                    readers: ["code_128_reader"]
                },
                locator: {
                    patchSize: patchSize,
                    halfSample: true
                },
                frequency: frequency
            };

            // Ajustes para alta resolu√ß√£o
            if (resolution === 'high') {
                config.inputStream.constraints.width = { min: 1280, ideal: 1920 };
                config.inputStream.constraints.height = { min: 720, ideal: 1080 };
                config.locator.halfSample = false; // Desativa meia-amostra para mais detalhes
            }

            return config;
        }

        async function initCamera() {
            try {
                status.textContent = "üîÑ Solicitando acesso √† c√¢mera...";
                
                // Para c√≥digos densos, preferir c√¢mera traseira (melhor qualidade)
                const constraints = {
                    video: {
                        width: { min: 1280, ideal: 1920 },
                        height: { min: 720, ideal: 1080 },
                        facingMode: { ideal: "environment" }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                camera.srcObject = stream;

                status.textContent = "‚úÖ C√¢mera ativa - Inicializando leitor...";

                // Inicializar Quagga ap√≥s a c√¢mera estar est√°vel
                setTimeout(initQuagga, 500);

            } catch (err) {
                console.error("Erro na c√¢mera:", err);
                status.textContent = "‚ùå Erro ao acessar c√¢mera: " + err.message;
                status.className = "status error";
            }
        }

        function initQuagga() {
            if (isInitialized) {
                Quagga.stop();
                Quagga.start();
                return;
            }

            const config = getQuaggaConfig();

            Quagga.init(config, function(err) {
                if (err) {
                    console.error("Erro Quagga:", err);
                    status.textContent = "‚ùå Erro no leitor: " + err.message;
                    status.className = "status error";
                    return;
                }

                console.log("Quagga inicializado com configura√ß√£o:", config);
                Quagga.start();
                isInitialized = true;
                status.textContent = "üîç Scanner ativo - Aponte para o c√≥digo";
                status.className = "status ready";

                updateDebugInfo("Leitor iniciado com configura√ß√µes otimizadas para c√≥digos densos");
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                result.innerHTML = `<strong style="color: #4CAF50; font-size: 18px;">‚úÖ C√≥digo lido: ${code}</strong>`;
                
                updateDebugInfo(`
                    Code: ${code}<br>
                    Formato: ${result.codeResult.format}<br>
                    Confian√ßa: ${(result.codeResult.decodedCodes[0].confidence * 100).toFixed(1)}%<br>
                    Zoom atual: ${currentZoom.toFixed(1)}x
                `);

                // Feedback visual
                document.getElementById('scan-area').style.borderColor = '#ff0000';
                setTimeout(() => {
                    document.getElementById('scan-area').style.borderColor = '#4CAF50';
                }, 500);
            });

            Quagga.onProcessed(function(result) {
                if (result && result.codeResult && result.codeResult.code) {
                    document.getElementById('scan-area').style.borderColor = '#ff9800';
                }
            });
        }

        function adjustZoom(delta) {
            currentZoom = Math.max(0.5, Math.min(3.0, currentZoom + delta));
            zoomLevel.textContent = currentZoom.toFixed(1) + 'x';
            
            // Aplicar zoom digital
            camera.style.transform = `scale(${currentZoom})`;
            camera.style.transformOrigin = 'center center';
            
            updateDebugInfo(`Zoom ajustado para: ${currentZoom.toFixed(1)}x - Ideal para c√≥digos densos: 1.5x a 2.0x`);
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (isInitialized) {
                Quagga.stop();
                isInitialized = false;
            }
            
            camera.srcObject = null;
            status.textContent = "‚èπ C√¢mera parada";
            result.textContent = "Aguardando leitura...";
            debugInfo.textContent = "";
            
            // Reset zoom
            currentZoom = 1.0;
            zoomLevel.textContent = '1.0x';
            camera.style.transform = 'scale(1)';
        }

        function updateDebugInfo(info) {
            debugInfo.innerHTML = `<strong>Debug:</strong> ${info}`;
        }

        // Atualizar configura√ß√µes em tempo real
        document.getElementById('resolution').addEventListener('change', function() {
            if (isInitialized) {
                status.textContent = "üîÑ Reiniciando com novas configura√ß√µes...";
                setTimeout(initQuagga, 500);
            }
        });

        document.getElementById('patchSize').addEventListener('change', function() {
            if (isInitialized) {
                initQuagga();
            }
        });

        // Dica inicial
        updateDebugInfo("Para c√≥digos densos como o 5786, use Zoom 1.5x-2.0x e configure 'Resolu√ß√£o Alta' + 'Tamanho X-Large'");

    </script>
</body>
</html>
